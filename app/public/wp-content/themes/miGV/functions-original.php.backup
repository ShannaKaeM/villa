<?php
/**
 * miGV Theme Functions
 * 
 * @package miGV
 * @version 1.0.0
 */

// Prevent direct access
if (!defined('ABSPATH')) {
    exit;
}

/**
 * Theme setup
 */
function migv_setup() {
    // Add theme support for various features
    add_theme_support('post-thumbnails');
    add_theme_support('title-tag');
    add_theme_support('custom-logo');
    add_theme_support('html5', array(
        'search-form',
        'comment-form',
        'comment-list',
        'gallery',
        'caption',
        'style',
        'script',
    ));
    
    // Add theme support for responsive embeds
    add_theme_support('responsive-embeds');
    
    // Add theme support for editor styles
    add_theme_support('editor-styles');
    add_editor_style('assets/css/editor-style.css');
    
    // Add theme support for wide and full alignment
    add_theme_support('align-wide');
    
    // Add theme support for block editor color palette
    add_theme_support('editor-color-palette');
    
    // Add theme support for custom line height
    add_theme_support('custom-line-height');
    
    // Add theme support for custom spacing
    add_theme_support('custom-spacing');
    
    // Add theme support for custom units
    add_theme_support('custom-units');
    
    // Register navigation menus
    register_nav_menus(array(
        'primary' => __('Primary Menu', 'migv'),
        'footer'  => __('Footer Menu', 'migv'),
    ));
    
    // Set content width
    if (!isset($content_width)) {
        $content_width = 1280;
    }
}
add_action('after_setup_theme', 'migv_setup');

/**
 * Enqueue scripts and styles
 */
function migv_scripts() {
    // Enqueue main stylesheet
    wp_enqueue_style(
        'migv-style',
        get_stylesheet_uri(),
        array(),
        wp_get_theme()->get('Version')
    );
    
    // Enqueue additional stylesheets
    wp_enqueue_style(
        'migv-blocks',
        get_template_directory_uri() . '/assets/css/blocks.css',
        array('migv-style'),
        wp_get_theme()->get('Version')
    );
    
    // Enqueue main JavaScript
    wp_enqueue_script(
        'migv-script',
        get_template_directory_uri() . '/assets/js/main.js',
        array(),
        wp_get_theme()->get('Version'),
        true
    );
    
    // Enqueue comment reply script
    if (is_singular() && comments_open() && get_option('thread_comments')) {
        wp_enqueue_script('comment-reply');
    }
    
    // Add inline styles for custom properties
    $custom_css = migv_get_custom_css();
    wp_add_inline_style('migv-style', $custom_css);
}
add_action('wp_enqueue_scripts', 'migv_scripts');

/**
 * Enqueue block editor assets
 */
function migv_block_editor_assets() {
    wp_enqueue_script(
        'migv-block-editor',
        get_template_directory_uri() . '/assets/js/block-editor.js',
        array('wp-blocks', 'wp-dom-ready', 'wp-edit-post'),
        wp_get_theme()->get('Version'),
        true
    );
}
add_action('enqueue_block_editor_assets', 'migv_block_editor_assets');

/**
 * Register widget areas
 */
function migv_widgets_init() {
    register_sidebar(array(
        'name'          => __('Sidebar', 'migv'),
        'id'            => 'sidebar-1',
        'description'   => __('Add widgets here to appear in your sidebar.', 'migv'),
        'before_widget' => '<section id="%1$s" class="widget %2$s">',
        'after_widget'  => '</section>',
        'before_title'  => '<h3 class="widget-title">',
        'after_title'   => '</h3>',
    ));
    
    register_sidebar(array(
        'name'          => __('Footer', 'migv'),
        'id'            => 'footer-1',
        'description'   => __('Add widgets here to appear in your footer.', 'migv'),
        'before_widget' => '<div id="%1$s" class="footer-widget %2$s">',
        'after_widget'  => '</div>',
        'before_title'  => '<h4 class="footer-widget-title">',
        'after_title'   => '</h4>',
    ));
}
add_action('widgets_init', 'migv_widgets_init');

/**
 * Custom block categories
 */
function migv_block_categories($categories) {
    return array_merge(
        $categories,
        array(
            array(
                'slug'  => 'migv-blocks',
                'title' => __('miGV Blocks', 'migv'),
                'icon'  => 'layout',
            ),
        )
    );
}
add_filter('block_categories_all', 'migv_block_categories', 10, 2);

/**
 * Register custom blocks
 */
function migv_register_blocks() {
    // Auto-register blocks from the blocks directory
    $blocks_dir = get_template_directory() . '/blocks';
    
    if (is_dir($blocks_dir)) {
        $blocks = scandir($blocks_dir);
        
        foreach ($blocks as $block) {
            if ($block === '.' || $block === '..') {
                continue;
            }
            
            $block_path = $blocks_dir . '/' . $block;
            
            if (is_dir($block_path) && file_exists($block_path . '/block.json')) {
                register_block_type($block_path);
            }
        }
    }
}
add_action('init', 'migv_register_blocks');

/**
 * Generate custom CSS
 */
function migv_get_custom_css() {
    $css = '';
    
    // Get customizer values and generate CSS
    $primary_color = get_theme_mod('migv_primary_color', '#2563eb');
    $secondary_color = get_theme_mod('migv_secondary_color', '#7c3aed');
    
    if ($primary_color !== '#2563eb' || $secondary_color !== '#7c3aed') {
        $css .= ':root {';
        
        if ($primary_color !== '#2563eb') {
            $css .= '--migv-primary: ' . esc_attr($primary_color) . ';';
            $css .= '--migv-primary-light: color-mix(in srgb, ' . esc_attr($primary_color) . ' 60%, white);';
            $css .= '--migv-primary-dark: color-mix(in srgb, ' . esc_attr($primary_color) . ' 80%, black);';
        }
        
        if ($secondary_color !== '#7c3aed') {
            $css .= '--migv-secondary: ' . esc_attr($secondary_color) . ';';
            $css .= '--migv-secondary-light: color-mix(in srgb, ' . esc_attr($secondary_color) . ' 60%, white);';
            $css .= '--migv-secondary-dark: color-mix(in srgb, ' . esc_attr($secondary_color) . ' 80%, black);';
        }
        
        $css .= '}';
    }
    
    return $css;
}

/**
 * Customizer settings
 */
function migv_customize_register($wp_customize) {
    // Colors section
    $wp_customize->add_section('migv_colors', array(
        'title'    => __('miGV Colors', 'migv'),
        'priority' => 30,
    ));
    
    // Primary color
    $wp_customize->add_setting('migv_primary_color', array(
        'default'           => '#2563eb',
        'sanitize_callback' => 'sanitize_hex_color',
    ));
    
    $wp_customize->add_control(new WP_Customize_Color_Control($wp_customize, 'migv_primary_color', array(
        'label'    => __('Primary Color', 'migv'),
        'section'  => 'migv_colors',
        'settings' => 'migv_primary_color',
    )));
    
    // Secondary color
    $wp_customize->add_setting('migv_secondary_color', array(
        'default'           => '#7c3aed',
        'sanitize_callback' => 'sanitize_hex_color',
    ));
    
    $wp_customize->add_control(new WP_Customize_Color_Control($wp_customize, 'migv_secondary_color', array(
        'label'    => __('Secondary Color', 'migv'),
        'section'  => 'migv_colors',
        'settings' => 'migv_secondary_color',
    )));
}
add_action('customize_register', 'migv_customize_register');

/**
 * Custom excerpt length
 */
function migv_excerpt_length($length) {
    return 25;
}
add_filter('excerpt_length', 'migv_excerpt_length');

/**
 * Custom excerpt more text
 */
function migv_excerpt_more($more) {
    return '...';
}
add_filter('excerpt_more', 'migv_excerpt_more');

/**
 * Add body classes
 */
function migv_body_classes($classes) {
    // Add class for block editor
    if (is_admin() && function_exists('get_current_screen')) {
        $screen = get_current_screen();
        if ($screen && $screen->is_block_editor()) {
            $classes[] = 'block-editor';
        }
    }
    
    // Add class for singular posts
    if (is_singular()) {
        $classes[] = 'singular';
    }
    
    // Add class for pages with sidebar
    if (is_active_sidebar('sidebar-1') && (is_page() || is_single())) {
        $classes[] = 'has-sidebar';
    }
    
    return $classes;
}
add_filter('body_class', 'migv_body_classes');

/**
 * Include additional files
 */
require get_template_directory() . '/inc/template-functions.php';
require get_template_directory() . '/inc/customizer.php';

// Include block patterns if they exist
if (file_exists(get_template_directory() . '/inc/block-patterns.php')) {
    require get_template_directory() . '/inc/block-patterns.php';
}

// Include custom post types if they exist
if (file_exists(get_template_directory() . '/inc/post-types.php')) {
    require get_template_directory() . '/inc/post-types.php';
}
